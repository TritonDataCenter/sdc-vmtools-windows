Find this ISO at https://download.joyent.com/pub/vmtools/winsetup*
Or on OSX:
# hdiutil makehybrid -o winsetup.iso winsetup/ -iso -joliet

This ISO currently sets up a full Windows install with v0.1.141 virtio drivers
for disk and networking, SAC console, ICMP ping, and RDP enabled.

On a SmartOS machine with the newest platform given to you by Joyent,
first set some variables for the bhyve VM used for Windows installation:

export WINDOWS_INSTALL_CD=/zones/win2016eval.iso
export WINDOWS_DRIVER_CD=/zones/winsetup.iso

zfs create -V 15G zones/windows
next:
zfs create -V 80G zones/windows

For Windows 2016:

pfexec /usr/sbin/bhyve -c 2 -m 3G -H \
    -l com1,stdio \
    -l bootrom,/usr/share/bhyve/uefi-rom.bin \
    -s 2,ahci-cd,$WINDOWS_INSTALL_CD \
    -s 3,virtio-blk,/dev/zvol/rdsk/zones/windows \
    -s 4,ahci-cd,$WINDOWS_DRIVER_CD \
    -s 31,lpc \
    windows

For Windows 2012:

pfexec /usr/sbin/bhyve -c 2 -m 3G -H \
    -l com1,stdio \
    -l bootrom,/usr/share/bhyve/uefi-rom.bin \
    -s 2,virtio-blk,/dev/zvol/rdsk/zones/windows \
    -s 3,ahci-cd,$WINDOWS_INSTALL_CD \
    -s 4,ahci-cd,$WINDOWS_DRIVER_CD \
    -s 31,lpc \
    windows

Now wait until bhyve terminates, which will take some time.

While Windows is doing its initial install phase, the Windows Special
Administrative Console will be displayed. If you'd rather watch the scrolling
install log rather than a blank screen, hit 'p' to disable paging and hit
<esc><tab> to switch to the install log when the 'SACSetupAct' message appears.

When bhyve terminates, run it again, but without the WINDOWS_INSTALL_CD line:

For Windows 2016:

pfexec /usr/sbin/bhyve -c 2 -m 3G -H \
    -l com1,stdio \
    -l bootrom,/usr/share/bhyve/uefi-rom.bin \
    -s 3,virtio-blk,/dev/zvol/rdsk/zones/windows \
    -s 4,ahci-cd,$WINDOWS_DRIVER_CD \
    -s 31,lpc \
    windows

For Windows 2012:

pfexec /usr/sbin/bhyve -c 2 -m 3G -H \
    -l com1,stdio \
    -l bootrom,/usr/share/bhyve/uefi-rom.bin \
    -s 2,virtio-blk,/dev/zvol/rdsk/zones/windows \
    -s 4,ahci-cd,$WINDOWS_DRIVER_CD \
    -s 31,lpc \
    windows

And wait for bhyve to terminate again. It will take a while, but not as long
as the first phase. We now move installation into a zone and the vmadm/imgadm
ecosystem. The initial installation phases above are done directly with bhyve in
the global zone since vmadm does not (yet) support the 'once' vmadm arg for
bhyve.

Now we create our image:

zfs send zones/windows | tee /zones/windows.zvol | digest -a sha1
zfs destroy zones/windows
/usr/sbin/bhyvectl --destroy --vm=windows
ls -l /zones/windows.zvol

Using the SHA1 hash and byte size from ls -l, fill in windows.imgmanifest:

{
    "v": 2,
    "uuid": "738dccbc-b1b6-11e8-bd8a-ab7098639442",
    "name": "windows-installing",
    "version": "0.0.1",
    "type": "zvol",
    "os": "windows",
    "files": [ {
        "sha1": "<windows.zvol SHA1 hash>",
        "size": <file size in byves>,
        "compression": "none"
    } ]
}

Then:

imgadm install -m /zones/windows.imgmanifest -f /zones/windows.zvol

You now have an imgadm image which can be used with vmadm; you can delete
windows.imgmanifest and windows.zvol. If you have a bunch of older images in
imgadm, you can clean them up with 'imgadm vacuum', which remove all images
that are not being currently used by a zone. Be careful you don't accidentally
vacuum your new image too!

Here's a JSON useful for 'vmadm create' which uses the above image:

{
  "brand": "bhyve",
  "vcpus": 2,
  "autoboot": false,
  "ram": 3072,
  "bootrom": "/usr/share/bhyve/uefi-rom.bin",
  "disks": [ {
    "boot": true,
    "model": "virtio",
    "image_uuid": "738dccbc-b1b6-11e8-bd8a-ab7098639442",
    "image_size": 15360
  } ],
  "nics": [ {
    "nic_tag": "admin",
    "model": "virtio",
    "ip": "10.88.88.69",
    "netmask": "255.255.255.0",
    "gateway": "10.88.88.2"
  } ],
  "resolvers": ["1.1.1.1", "1.0.0.1"]
}

Put that in a JSON file (e.g. windows.json), and adjust the networking to taste.
Then creat a new VM and start it:

vmadm create -f windows.json 
vmadm start <new VM's UUID>

RDP should become available once Windows boots up. Alternatively, use VNC,
or 'vmadm console' to access Windows' SAC.
